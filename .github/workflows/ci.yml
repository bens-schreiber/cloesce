name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  CARGO_HOME: ${{ github.workspace }}/.cargo
  RUSTUP_HOME: ${{ github.workspace }}/.rustup

jobs:
  ci:
    name: Check & Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      # --- Rust Setup ---
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
          targets: wasm32-unknown-unknown, wasm32-wasip1
      
      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/orm/target
            src/generator/target
          key: cargo-${{ hashFiles('**/Cargo.lock') }}

      # --- ORM ---
      - name: Check & Build & Test ORM
        working-directory: src/orm
        run: |
          cargo fmt -- --check
          cargo clippy --all-targets --all-features -- -D warnings
          cargo build --target wasm32-unknown-unknown --release
          cargo test

      # --- Generator ---
      - name: Check & Build & Test Generator
        working-directory: src/generator
        run: |
          cargo fmt -- --check
          cargo clippy --all-targets --all-features -- -D warnings
          cargo build --release
          cargo build --target wasm32-wasip1 --release
          cargo test

      # --- Node Setup ---
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: npm-cache-${{ hashFiles('**/package-lock.json') }}

      # --- Frontend TS ---    
      - name: Check & Build & Test Frontend TS
        working-directory: src/ts
        run: |
          npm install
          npm run format -- --check
          npm run typecheck
          npm run build
          npm test

      # --- Build E2E Tests ---
      - name: Build E2E
        working-directory: tests/e2e
        run: |
          npm install
          npm run format -- --check

      # --- Integration Tests ---
      - name: Regression Tests
        working-directory: tests/regression
        run: cargo run --bin regression -- --check

      # --- E2E Tests ---
      - name: Check & Test E2E
        working-directory: tests/e2e
        run: |
          npm test
