name: CI

on:
  push:
    branches: ["main", "release/*"]
    paths-ignore:
      - "**/*.md"
      - "docs/**"
      - "examples/**"

  pull_request:
    branches: ["main", "release/*"]
    paths-ignore:
      - "**/*.md"
      - "docs/**"
      - "examples/**"

env:
  CARGO_HOME: ${{ github.workspace }}/.cargo
  RUSTUP_HOME: ${{ github.workspace }}/.rustup

jobs:
  ci:
    name: Check & Build & Test
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      # --- Rust Setup ---
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
          targets: wasm32-unknown-unknown, wasm32-wasip1

      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/orm/target
            src/generator/target
          key: cargo-${{ hashFiles('**/Cargo.lock') }}

      # --- Node Setup ---
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/cache@v3
        with:
          path: ~/.npm
          key: npm-cache-${{ hashFiles('**/package-lock.json') }}

      # --- Build ---
      - name: Build source code
        run: make build-src
      
      # --- Format and Lint ---
      - name: Check code formatting
        run: make format-check


      # --- Test ---
      - name: Run all tests
        run: make test
