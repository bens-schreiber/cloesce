type Ok<T> = { ok: true; data: T };
type Err = { ok: false; status: number; message: string };
type Result<T> = Ok<T> | Err;

function instantiateModelArray<T>(data: any, ctor: { new(): T }): T[] {
  if (Array.isArray(data)) {
    return data.map(x => instantiateModelArray(x, ctor)).flat();
  }
  return [Object.assign(new ctor(), data)];
}

{{#each models}}
export class {{name}} {
  {{#each attributes}}
  {{value.name}}: {{lang_type value.cidl_type value.nullable}};
  {{/each}}

  {{#each methods}}
  {{#if is_static}}static {{/if}}async {{name}}(
    {{#each parameters}}
      {{#if (is_serializable cidl_type)}}
        {{name}}: {{lang_type cidl_type nullable}}{{#unless @last}}, {{/unless}}
      {{/if}}
    {{/each}}
  ): Promise<Result<{{lang_type return_type}}>> {
    const baseUrl = `{{../../domain}}/{{#if is_static}}{{../name}}/{{name}}{{else}}{{../name}}/${this.id}/{{name}}{{/if}}`;

    {{#if (eq http_verb "GET")}}
    const url = new URL(baseUrl);
    {{#each parameters}}
    {{#if (is_serializable cidl_type)}}
    url.searchParams.append('{{name}}', String({{name}}));
    {{/if}}
    {{/each}}
    const res = await fetch(url.toString(), {
      method: "GET"
    });
    {{else}}
    const res = await fetch(baseUrl, {
      method: "{{http_verb}}",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        {{#each parameters}}
          {{#if (is_serializable cidl_type)}}
            {{name}}{{#unless @last}}, {{/unless}}
          {{/if}}
        {{/each}}
      })
    });
    {{/if}}

    if (!res.ok) {
      const message = await res.text();
      return {
        ok: false,
        status: res.status,
        message
      };
    }

    const data = await res.json();

    {{#if (is_model return_type)}}
    const instantiated = Object.assign(new {{../name}}(), data);
    return { ok: true, data: instantiated };
    {{else}}
      {{#if (is_model_array return_type)}}
    const instantiated = instantiateModelArray(data, {{../name}});
    return { ok: true, data: instantiated };
      {{else}}
    return { ok: true, data };
      {{/if}}
    {{/if}}
  }
  {{/each}}
}
{{/each}}