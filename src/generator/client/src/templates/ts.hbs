import { HttpResult, instantiateObjectArray, DeepPartial } from "cloesce/client";

{{#each poos}}
export class {{this.name}} {
  {{#each this.attributes}}
  {{name}}: {{get_cidl_type cidl_type}};
  {{/each}}
}
{{/each}}
{{#each models}}
export class {{this.name}} {
  {{this.primary_key.name}}: {{get_cidl_type this.primary_key.cidl_type}};
  {{#each this.attributes}}
  {{value.name}}: {{get_cidl_type value.cidl_type}};
  {{/each}}
  {{#each this.navigation_properties}}
  {{var_name}}: {{get_nav_cidl_type this}}{{#if (is_one_to_one this)}} | undefined{{/if}};
  {{/each}}

  {{#each this.methods}}
  {{#if this.is_static}}static {{/if}}async {{this.name}}(
    {{#each this.parameters}}
      {{#if (is_serializable cidl_type)}}
        {{name}}: {{get_cidl_type cidl_type}},
      {{/if}}
    {{/each}}
    dataSource: {{#each ../data_sources}}"{{name}}" | {{/each}}null = null
  ): Promise<HttpResult<{{get_cidl_type this.return_type}}>> {
    const baseUrl = new URL(`{{../../domain}}/{{#if this.is_static}}{{../name}}/{{this.name}}{{else}}{{../name}}/${this.id}/{{this.name}}{{/if}}`);
    baseUrl.searchParams.append("dataSource", String(dataSource));
    {{#if (eq this.http_verb "GET")}}
      {{#each this.parameters}}
        {{#if (is_serializable cidl_type)}}
    baseUrl.searchParams.append('{{name}}', String({{name}}));
        {{/if}}
      {{/each}}
    const res = await fetch(baseUrl, { method: "GET" });
    {{else}}
    const res = await fetch(baseUrl, {
      method: "{{this.http_verb}}",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        {{#each this.parameters}}
          {{#if (is_serializable cidl_type)}}
            {{name}}{{#unless @last}}, {{/unless}}
          {{/if}}
        {{/each}}
      })
    });
    {{/if}}
    let raw = await res.json();
    if (!res.ok) {
      return raw;
    }
    {{#if (eq (get_cidl_type this.return_type) "void")}}
    return raw;
    {{else if (is_object_array this.return_type)}}
    raw.data = instantiateObjectArray(raw.data, {{object_name this.return_type}});
    return raw;
    {{else if (is_object this.return_type)}}
    raw.data = Object.assign(new {{object_name this.return_type}}(), raw.data);
    return raw;
    {{else}}
    return raw;
    {{/if}}
  }
  {{/each}}
  {{#each this.cruds}}
  {{#if (crud_name this "POST")}}
  static async post(obj: DeepPartial<{{../name}}>, dataSource: {{#each ../data_sources}}"{{name}}" | {{/each}}null = null): Promise<HttpResult<{{../name}}>> {
    const baseUrl = new URL(`{{../../domain}}/{{../name}}/post`);
    baseUrl.searchParams.append("dataSource", String(dataSource));

    const res = await fetch(baseUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(obj)
    });

    let raw = await res.json();
    if (!res.ok) {
      return raw;
    }

    raw.data = Object.assign(new {{../name}}(), raw.data);
    return raw;
  }
  {{/if}}
  {{#if (crud_name this "PATCH")}}
  async patch(dataSource: {{#each ../data_sources}}"{{name}}" | {{/each}}null = null): Promise<HttpResult<void>> {
    const baseUrl = new URL(`{{../../domain}}/{{../name}}/patch`);
    baseUrl.searchParams.append("dataSource", String(dataSource));

    const res = await fetch(baseUrl, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(this)
    });

    let raw = await res.json();
    if (!res.ok) {
      return raw;
    }

    Object.assign(this, raw.data);
    return raw;
  }
  {{/if}}
  {{#if (crud_name this "GET")}}
  static async get({{../primary_key.name}}: {{get_cidl_type ../primary_key.cidl_type}}, dataSource: {{#each ../data_sources}}"{{name}}" | {{/each}}null = null): Promise<HttpResult<{{../name}}>> {
    const baseUrl = new URL(`{{../../domain}}/{{../name}}/get`);
    baseUrl.searchParams.append("dataSource", String(dataSource));
    baseUrl.searchParams.append("{{../primary_key.name}}", String({{../primary_key.name}}));

    const res = await fetch(baseUrl, { method: "GET" });

    let raw = await res.json();
    if (!res.ok) {
      return raw;
    }

    raw.data = Object.assign(new {{../name}}(), raw.data);
    return raw;
  }
  {{/if}}
  {{#if (crud_name this "LIST")}}
  static async list(dataSource: {{#each ../data_sources}}"{{name}}" | {{/each}}null = null): Promise<HttpResult<{{../name}}[]>> {
    const baseUrl = new URL(`{{../../domain}}/{{../name}}/list`);
    baseUrl.searchParams.append("dataSource", String(dataSource));

    const res = await fetch(baseUrl, { method: "GET" });

    let raw = await res.json();
    if (!res.ok) {
      return raw;
    }

    raw.data = instantiateObjectArray(raw.data, {{../name}});
    return raw;
  }
  {{/if}}
  {{/each}}
}
{{/each}}
