# Sprint 1 Report

## YouTube Link for Sprint 2 Video
https://youtu.be/kSQIpW6WkRc

---

## What's New (User Facing)
*(They happen to be GitHub PRs)*

- Included **primary key and CRUD handling** for IR (Intermediate Representation) file output
- Constructed **Rust compiler** for compiling IR into Wrangler-compatible files for deployment on Cloudflare Workers
- Built **Rust compiler** which compiles IR to SQL migrations for Wrangler-compatible databases
- Added foreign key relationships between models
- Added **data sources with include trees** for managing which relations hydrate on queries
- Included **method return type support** for custom endpoints
- Used **navigation properties** for movement between model relationships
- Replaced the state machine generated by Rust with a **single TypeScript runtime `cloesce` function**
- Better **developer ergonomics** through connecting at runtime the compiler-generated `cidl.json` metadata
- Added a **Constructor Registry** for registering model names against their TypeScript definitions

---

## Work Summary (developer side)

It was a sprint on **designing the ground-up infrastructure of Cloesce** — converting it from an idea into a functional **ORM/compiler for serverless architectures**.

Cloesce is created to enable developers to declare simple models using languages like **TypeScript** and have everything required to deploy such models as a full stack serverless application automatically generated:

- a database schema (D1/SQLite)
- a REST backend API på Cloudflare Workers
- A Frontend Client like Swagger
- infrastructure configuration (Wrangler)

Before that, there was no actual backend/runtime — just crude plans for compiling TypeScript into a JSON manifest.
For this sprint, both PF/miniref teams developed a **real compiler** which:

1. Interprets user code with decorators such as `@D1`, `@GET`, `@POST` into an **Intermediate Representation (IR)**.
2. Translates this IR through a **Rust compiler** into Wrangler-ready files, SQL migrations, and deployment artifacts.
3. Binds this IR at runtime through a new **TypeScript engine** called `cloesce`, which at runtime dynamically routes requests, validates inputs, hydrates data, and invokes user logic.

### Primary Technical Issues

It was one of the thorniest issues: **hydration of data** — converting flat SQL rows (with custom one-to-many/many-to-many relationships) into properly instantiated objects. Naïve solution wasn't an option due to weak support for JSON files in SQLite, so we introduced an **intelligent hydration algorithm** with the help of compile-time metadata (`cidl.json`).

We also introduced **Include Trees**, allowing users to explicitly declare which related models should be populated for SQL queries. This eliminated confusion when retrieving deep-nested relationships.

Additionally, we provided a **Constructor Registry** which maps model names back to user-specified implementation at runtime for dynamic dispatching.

This effort **re-architected the project**, transitioning from a fixed-in-place Rust TypeScript-generator to a **deterministic TypeScript runtime** which is unit-testable, extensible to additional languages (Python next on the list, a future target being Rust), and greatly minimizes boilerplate for end-users.

---

## Incomplete Work

Even though we established the main runtime and compiler pipeline, some future planned improvements were pushed behind:

- **NPM Orchestration** – Publishing to npm is still under development to ensure smooth production readiness.
- **Support for expanded return types** — pushed off until v0.0.3 to decrease risk and solidify the foundation.
- **Further boilerplate removal** — initiated, but not yet refined enough for shipping.
- **Real-world bug hunting** — postponed until the next sprint for the implementation of the new architecture using real projects.

---

## Completed Issues / User Stories

- https://github.com/your_repo/issues/primary-key-and-crud-ir  
- https://github.com/your_repo/issues/rust-compiler-wrangler-output  
- https://github.com/your_repo/issues/rust-compiler-sql-migrations  
- https://github.com/your_repo/issues/foreign-key-relationships  
- https://github.com/your_repo/issues/include-tree-data-sources  
- https://github.com/your_repo/issues/navigation-properties  
- https://github.com/your_repo/issues/method-return-types  
- https://github.com/your_repo/issues/runtime-hydration-cidl-linking  
- https://github.com/your_repo/issues/constructor-registry  
---

## Incomplete Issues / User Stories

- [#70](https://github.com/bens-schreiber/cloesce/issues/70) — Supporting multiple database bindings required deeper architectural changes than possible in this sprint.
- [#66](https://github.com/bens-schreiber/cloesce/issues/66) — Native authentication design proved too complex to finalize within the sprint.
- [#65](https://github.com/bens-schreiber/cloesce/issues/65) — WASM-based universal ORM research was too exploratory for the sprint scope.
- [#58](https://github.com/bens-schreiber/cloesce/issues/58) — Refactoring the e2e test harness was more time-consuming than expected.
- [#56](https://github.com/bens-schreiber/cloesce/issues/56) — Bugs keep coming in; a dedicated bug sprint is needed.
- [#54](https://github.com/bens-schreiber/cloesce/issues/54) — Supporting namespace-less functions required deeper specification changes.
- [#52](https://github.com/bens-schreiber/cloesce/issues/52) — CRUD codegen alignment created too many open design decisions.
- [#51](https://github.com/bens-schreiber/cloesce/issues/51) — Complex model detection in GET requests required more analysis than time allowed.
- [#46](https://github.com/bens-schreiber/cloesce/issues/46) — Bundling Rust binaries and npm orchestration required larger production-level design work.
- [#28](https://github.com/bens-schreiber/cloesce/issues/28) — Middleware injection system design needed more experimentation and planning.

---

## Code Files for Review

- [`Extractor code`](https://github.com/bens-schreiber/cloesce/tree/main/src/extractor/ts) — Extracts metadata from TypeScript into `cidl.json` for Cloudflare Workers.
- [`Rust compiler code`](https://github.com/bens-schreiber/cloesce/tree/main/src/generator) — Generates Cloudflare Workers files and SQL migrations.

---

## Retrospective Summary

### What Went Well
- Constructed the **entire foundation** of Cloesce from ground zero — idea through functional ORM/compiler for serverless programs.
- Solving the difficult **data hydration problem** for deeply nested relationships without using SQLite JSON.

- Dramatically improved **developer experience** — simple, easy-to-test deterministic TypeScript runtime replaces tricky Rust codegen.

- Configure architecture to be **multi-language friendly** (Python parity scheduled next). 
### What We'd Like to Change 
- Hydration algorithm requires **real-world validation and edge case testing**. 
- **Documentation** should clarify Include Trees, IR metadata (`.cidl.json`), and runtime linking more clearly. 
- **Build performance** dipped slightly — optimize metadata extraction pipeline. ### ???? v0.0.3 Next Sprint 
- **Orchestration of NPM & publishing packages**. 
- Expand **return type support** and less boilerplate for developers. 
- Do a **bug-hunt sprint** on actual sample projects. 
- Shorten **build times** and metadata extraction time. 
- Begin **multi-language runtime investigation**, beginning with parity for Python.